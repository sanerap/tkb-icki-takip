// Import Firebase modules
import { initializeApp as initFirebase } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getDatabase, ref, onValue, set, update, remove, get } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

// Firebase configuration
const firebaseConfig = {
    apiKey: "AIzaSyBMVTZBMXjBDT45foOQPGCnL5xNRqWNEkw",
    authDomain: "drink-tracker-b7bc1.firebaseapp.com",
    databaseURL: "https://drink-tracker-b7bc1-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "drink-tracker-b7bc1",
    storageBucket: "drink-tracker-b7bc1.firebasestorage.app",
    messagingSenderId: "88411843150",
    appId: "1:88411843150:web:eb86e61187f2cae7b1311f"
};

// Initialize Firebase
const app = initFirebase(firebaseConfig);
const database = getDatabase(app);

// Monitor connection status
const connectionStatus = document.getElementById('connectionStatus');
const connectedRef = ref(database, '.info/connected');
onValue(connectedRef, (snapshot) => {
    if (snapshot.val() === true) {
        connectionStatus.textContent = '‚úì Baƒülandƒ±';
        connectionStatus.className = 'connection-status online';
    } else {
        connectionStatus.textContent = '‚ö† √áevrimdƒ±≈üƒ±';
        connectionStatus.className = 'connection-status offline';
    }
});

// Session state
let currentSession = localStorage.getItem('currentSession');
let isAdmin = localStorage.getItem('isAdmin') === 'true';
let adminCode = localStorage.getItem('adminCode');
let userId = localStorage.getItem('userId');
let currentParticipantId = localStorage.getItem('currentParticipantId');

// Generate user ID if not exists
if (!userId) {
    userId = 'user_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
    localStorage.setItem('userId', userId);
}

// Notification permission
let notificationsEnabled = false;

// Request notification permission
async function requestNotificationPermission() {
    if (!('Notification' in window)) {
        console.log('This browser does not support notifications');
        return false;
    }

    console.log('Current notification permission:', Notification.permission);

    if (Notification.permission === 'granted') {
        notificationsEnabled = true;
        console.log('Notifications already granted');
        return true;
    }

    if (Notification.permission !== 'denied') {
        const permission = await Notification.requestPermission();
        notificationsEnabled = permission === 'granted';
        console.log('Permission request result:', permission, 'notificationsEnabled:', notificationsEnabled);
        return notificationsEnabled;
    }

    console.log('Notifications denied');
    return false;
}

// Show browser notification
function showBrowserNotification(title, body, options = {}) {
    console.log('showBrowserNotification called:', {
        title,
        body,
        notificationsEnabled,
        permission: Notification.permission
    });

    if (!notificationsEnabled) {
        console.warn('Notifications not enabled');
        return;
    }

    const notification = new Notification(title, {
        body: body,
        icon: 'üç∫',
        badge: 'üç∫',
        tag: 'drink-notification',
        requireInteraction: false,
        ...options
    });

    console.log('Notification created:', notification);

    // Auto close after 5 seconds
    setTimeout(() => notification.close(), 5000);

    // Play sound
    playNotificationSound();

    // Vibrate
    if (navigator.vibrate) {
        navigator.vibrate([200, 100, 200]);
    }
}

// Play notification sound
function playNotificationSound() {
    // Simple beep sound using Web Audio API
    try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();

        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);

        oscillator.frequency.value = 800;
        oscillator.type = 'sine';

        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);

        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.5);
    } catch (e) {
        console.log('Could not play sound:', e);
    }
}

// Session data
let sessionData = {
    participants: {},
    drinks: {},
    drinkTypes: [],
    drinkHistory: {},
    undoStack: [],
    notifications: []  // New: Persistent notifications
};

// Temporary data for session creation
let tempParticipants = [];
let pendingAction = null;
let pendingAdminAction = null;

// DOM elements
const sessionManagement = document.getElementById('sessionManagement');
const sessionInfo = document.getElementById('sessionInfo');
const sessionCodeDisplay = document.getElementById('sessionCodeDisplay');
const sessionRole = document.getElementById('sessionRole');
const mainContent = document.getElementById('mainContent');
const notificationsContent = document.getElementById('notificationsContent');
const approvalsContent = document.getElementById('approvalsContent');
const tabNavigation = document.getElementById('tabNavigation');
const mainTab = document.getElementById('mainTab');
const notificationsTab = document.getElementById('notificationsTab');
const approvalsTab = document.getElementById('approvalsTab');
const notificationCount = document.getElementById('notificationCount');
const approvalCount = document.getElementById('approvalCount');

// Modal elements
const createSessionModal = document.getElementById('createSessionModal');
const sessionCreatedModal = document.getElementById('sessionCreatedModal');
const joinSessionModal = document.getElementById('joinSessionModal');
const selectParticipantModal = document.getElementById('selectParticipantModal');
const addParticipantSessionModal = document.getElementById('addParticipantSessionModal');
const addDrinkModal = document.getElementById('addDrinkModal');
const adjustDrinkModal = document.getElementById('adjustDrinkModal');
const deleteDrinkModal = document.getElementById('deleteDrinkModal');
const adminCodeModal = document.getElementById('adminCodeModal');

// Generate session code
function generateSessionCode() {
    const words = ['ASLAN', 'KARTAL', 'KURT', 'PARS', 'AYAK', 'DALGA', 'DENIZ', 'GUNES', 'YILDIZ', 'BULUT', 'FIRTINA', 'DAGLAR', 'ORMAN', 'GOKYUZU', 'RUZGAR'];
    const word = words[Math.floor(Math.random() * words.length)];
    const num = Math.floor(10 + Math.random() * 90);
    return `${word}${num}`;
}

// Generate admin code
function generateAdminCode() {
    return Math.floor(1000 + Math.random() * 9000).toString();
}

// Generate participant ID
function generateParticipantId() {
    return 'p_' + Math.random().toString(36).substr(2, 9);
}

// Show toast notification
function showToast(message, type = 'info') {
    const toastContainer = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.innerHTML = `<div class="toast-message">${message}</div>`;
    toastContainer.appendChild(toast);

    setTimeout(() => {
        toast.style.animation = 'slideIn 0.3s ease-out reverse';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// Initialize app
initializeApp();

// Tab Navigation
mainTab.addEventListener('click', () => {
    mainTab.classList.add('active');
    notificationsTab.classList.remove('active');
    approvalsTab.classList.remove('active');
    mainContent.classList.remove('hidden');
    notificationsContent.classList.add('hidden');
    approvalsContent.classList.add('hidden');
});

notificationsTab.addEventListener('click', () => {
    notificationsTab.classList.add('active');
    mainTab.classList.remove('active');
    approvalsTab.classList.remove('active');
    notificationsContent.classList.remove('hidden');
    mainContent.classList.add('hidden');
    approvalsContent.classList.add('hidden');
    renderNotifications();
});

approvalsTab.addEventListener('click', () => {
    approvalsTab.classList.add('active');
    mainTab.classList.remove('active');
    notificationsTab.classList.remove('active');
    approvalsContent.classList.remove('hidden');
    mainContent.classList.add('hidden');
    notificationsContent.classList.add('hidden');
    renderApprovals();
});

// Add notification to session
async function addNotification(message, type = 'info') {
    const notification = {
        id: Date.now(),
        message: message,
        type: type,
        timestamp: Date.now()
    };

    const notifications = sessionData.notifications || [];
    notifications.push(notification);

    try {
        await update(ref(database, `sessions/${currentSession}`), {
            notifications: notifications
        });
    } catch (error) {
        console.error('Failed to add notification:', error);
    }
}

// Render notifications
function renderNotifications() {
    const notifications = sessionData.notifications || [];

    if (notifications.length === 0) {
        notificationsContent.innerHTML = '<div class="empty-notifications">Hen√ºz bildirim yok</div>';
        return;
    }

    // Sort by timestamp, newest first
    const sortedNotifications = [...notifications].sort((a, b) => b.timestamp - a.timestamp);

    let html = '';
    sortedNotifications.forEach(notification => {
        const timeAgo = getTimeAgo(notification.timestamp);
        html += `
            <div class="notification-item ${notification.type}">
                <div class="notification-content">
                    <div class="notification-message">${notification.message}</div>
                    <div class="notification-time">${timeAgo}</div>
                </div>
                ${isAdmin ? `<button class="notification-delete" onclick="window.deleteNotification(${notification.id})">‚úï</button>` : ''}
            </div>
        `;
    });

    notificationsContent.innerHTML = html;
}

// Delete notification
window.deleteNotification = async function(notificationId) {
    if (!isAdmin) return;

    const notifications = (sessionData.notifications || []).filter(n => n.id !== notificationId);

    try {
        await update(ref(database, `sessions/${currentSession}`), {
            notifications: notifications
        });
    } catch (error) {
        alert('Bildirim silinirken hata: ' + error.message);
    }
};

// Get time ago string
function getTimeAgo(timestamp) {
    const now = Date.now();
    const diff = now - timestamp;
    const minutes = Math.floor(diff / 60000);
    const hours = Math.floor(minutes / 60);
    const days = Math.floor(hours / 24);

    if (minutes < 1) return 'Az √∂nce';
    if (minutes < 60) return `${minutes} dakika √∂nce`;
    if (hours < 24) return `${hours} saat √∂nce`;
    return `${days} g√ºn √∂nce`;
}

// Update notification count badge
function updateNotificationCount() {
    const count = (sessionData.notifications || []).length;
    if (count > 0) {
        notificationCount.textContent = count;
        notificationCount.classList.remove('hidden');
    } else {
        notificationCount.classList.add('hidden');
    }
}

// Update approval count badge
function updateApprovalCount() {
    const count = Object.keys(sessionData.pendingDeletions || {}).length;
    if (count > 0) {
        approvalCount.textContent = count;
        approvalCount.classList.remove('hidden');
    } else {
        approvalCount.classList.add('hidden');
    }
}

// Render approvals
function renderApprovals() {
    if (!isAdmin) {
        approvalsContent.innerHTML = '<div class="empty-notifications">Sadece y√∂netici onaylarƒ± g√∂rebilir</div>';
        return;
    }

    const pendingDeletions = sessionData.pendingDeletions || {};
    const deletionEntries = Object.entries(pendingDeletions);

    if (deletionEntries.length === 0) {
        approvalsContent.innerHTML = '<div class="empty-notifications">Onay bekleyen i≈ülem yok</div>';
        return;
    }

    let html = '';
    deletionEntries.forEach(([deleteId, deletion]) => {
        const timeAgo = getTimeAgo(deletion.requestedAt);
        html += `
            <div class="pending-approval">
                <div style="margin-bottom: 10px;">
                    <div class="pending-approval-text" style="font-size: 16px; margin-bottom: 5px;">
                        ${deletion.participantName} - ${deletion.drinkType} silmek istiyor
                    </div>
                    <div style="color: #6c757d; font-size: 12px;">${timeAgo}</div>
                </div>
                <div class="pending-approval-actions">
                    <button class="btn-success" onclick="window.approveDeletion('${deleteId}')">‚úì Onayla</button>
                    <button class="btn-danger" onclick="window.rejectDeletion('${deleteId}')">‚úï Reddet</button>
                </div>
            </div>
        `;
    });

    approvalsContent.innerHTML = html;
}

function initializeApp() {
    // Request notification permission on app load
    requestNotificationPermission();

    if (currentSession) {
        loadSession(currentSession);
    } else {
        showSessionManagement();
    }
}

function showSessionManagement() {
    sessionManagement.classList.remove('hidden');
    sessionInfo.classList.add('hidden');
    tabNavigation.classList.add('hidden');
    mainContent.innerHTML = '';
    notificationsContent.innerHTML = '';
    approvalsContent.innerHTML = '';
}

function showSessionInfo() {
    sessionManagement.classList.add('hidden');
    sessionInfo.classList.remove('hidden');
    tabNavigation.classList.remove('hidden');
    sessionCodeDisplay.textContent = currentSession;

    // Count active participants
    const activeCount = sessionData.participants ?
        Object.values(sessionData.participants).filter(p => p.isActive).length : 0;

    if (isAdmin) {
        sessionRole.textContent = `Y√∂netici (${activeCount} ki≈üi)`;
        sessionRole.className = 'session-role admin';
    } else {
        const participantName = sessionData.participants?.[currentParticipantId]?.name || 'Katƒ±lƒ±mcƒ±';
        sessionRole.textContent = participantName;
        sessionRole.className = 'session-role';
    }

    updateNotificationCount();
    if (isAdmin) {
        updateApprovalCount();
        approvalsTab.classList.remove('hidden');
    } else {
        approvalsTab.classList.add('hidden');
    }
}

// Create Session - Open Modal
document.getElementById('createSessionBtn').addEventListener('click', () => {
    tempParticipants = [];
    updateParticipantListUI();
    createSessionModal.classList.remove('hidden');
    document.getElementById('participantNameInput').focus();
});

// Add Participant to temp list
document.getElementById('addParticipantBtn').addEventListener('click', addTempParticipant);
document.getElementById('participantNameInput').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') addTempParticipant();
});

function addTempParticipant() {
    const input = document.getElementById('participantNameInput');
    const name = input.value.trim();

    if (!name) {
        alert('L√ºtfen bir isim girin');
        return;
    }

    if (tempParticipants.some(p => p.name.toLowerCase() === name.toLowerCase())) {
        alert('Bu isim zaten eklendi');
        return;
    }

    tempParticipants.push({
        id: generateParticipantId(),
        name: name
    });

    input.value = '';
    input.focus();
    updateParticipantListUI();
}

function updateParticipantListUI() {
    const list = document.getElementById('participantList');
    const confirmBtn = document.getElementById('confirmCreateSession');

    if (tempParticipants.length === 0) {
        list.innerHTML = '<div class="empty-state" style="padding: 20px;">Hen√ºz katƒ±lƒ±mcƒ± eklenmedi</div>';
        confirmBtn.disabled = true;
        confirmBtn.textContent = 'Oturumu Ba≈ülat (0 ki≈üi)';
    } else {
        list.innerHTML = tempParticipants.map(p => `
            <div class="participant-list-item">
                <span>${p.name}</span>
                <button onclick="window.removeTempParticipant('${p.id}')">‚úï Sil</button>
            </div>
        `).join('');
        confirmBtn.disabled = false;
        confirmBtn.textContent = `Oturumu Ba≈ülat (${tempParticipants.length} ki≈üi)`;
    }
}

window.removeTempParticipant = function(id) {
    tempParticipants = tempParticipants.filter(p => p.id !== id);
    updateParticipantListUI();
};

// Cancel Create Session
document.getElementById('cancelCreateSession').addEventListener('click', () => {
    createSessionModal.classList.add('hidden');
    tempParticipants = [];
});

// Confirm Create Session
document.getElementById('confirmCreateSession').addEventListener('click', async () => {
    if (tempParticipants.length === 0) return;

    let sessionCode;
    let attempts = 0;

    while (attempts < 10) {
        sessionCode = generateSessionCode();
        const sessionRef = ref(database, `sessions/${sessionCode}`);
        const snapshot = await get(sessionRef);

        if (!snapshot.exists()) break;
        attempts++;
    }

    if (attempts >= 10) {
        alert('Benzersiz oturum kodu olu≈üturulamadƒ±. L√ºtfen tekrar deneyin.');
        return;
    }

    const adminCodeValue = generateAdminCode();
    const participants = {};

    tempParticipants.forEach(p => {
        participants[p.id] = {
            name: p.name,
            userId: null,
            addedAt: Date.now(),
            addedBy: 'admin',
            isActive: true
        };
    });

    const newSessionData = {
        adminCode: adminCodeValue,
        adminUserId: userId,
        createdAt: Date.now(),
        participants: participants,
        drinks: {},
        drinkTypes: [],
        drinkHistory: {},
        undoStack: [],
        notifications: []
    };

    try {
        await set(ref(database, `sessions/${sessionCode}`), newSessionData);

        currentSession = sessionCode;
        isAdmin = true;
        adminCode = adminCodeValue;
        localStorage.setItem('currentSession', sessionCode);
        localStorage.setItem('isAdmin', 'true');
        localStorage.setItem('adminCode', adminCodeValue);

        createSessionModal.classList.add('hidden');

        document.getElementById('newSessionCode').textContent = sessionCode;
        document.getElementById('newAdminCode').textContent = adminCodeValue;
        sessionCreatedModal.classList.remove('hidden');
    } catch (error) {
        alert('Oturum olu≈üturulurken hata: ' + error.message);
    }
});

// Close Session Created Modal
document.getElementById('closeSessionCreatedModal').addEventListener('click', () => {
    sessionCreatedModal.classList.add('hidden');
    loadSession(currentSession);
});

// Join Session - Step 1: Code Entry
document.getElementById('joinSessionBtn').addEventListener('click', () => {
    joinSessionModal.classList.remove('hidden');
    document.getElementById('joinSessionCodeInput').value = '';
    document.getElementById('joinSessionCodeInput').focus();
});

document.getElementById('cancelJoinSession').addEventListener('click', () => {
    joinSessionModal.classList.add('hidden');
});

document.getElementById('joinSessionCodeInput').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') document.getElementById('confirmJoinSessionCode').click();
});

document.getElementById('confirmJoinSessionCode').addEventListener('click', async () => {
    const code = document.getElementById('joinSessionCodeInput').value.trim().toUpperCase();

    if (!code) {
        alert('L√ºtfen bir oturum kodu girin');
        return;
    }

    try {
        const sessionRef = ref(database, `sessions/${code}`);
        const snapshot = await get(sessionRef);

        if (!snapshot.exists()) {
            alert('Oturum bulunamadƒ±. L√ºtfen kodu kontrol edip tekrar deneyin.');
            return;
        }

        const data = snapshot.val();
        const participantSelect = document.getElementById('participantSelect');
        participantSelect.innerHTML = '<option value="">Se√ßin...</option>';

        Object.entries(data.participants).forEach(([id, participant]) => {
            if (participant.isActive) {
                participantSelect.innerHTML += `<option value="${id}">${participant.name}</option>`;
            }
        });

        document.getElementById('joiningSessionCode').textContent = code;
        joinSessionModal.classList.add('hidden');
        selectParticipantModal.classList.remove('hidden');

        currentSession = code;
    } catch (error) {
        alert('Oturuma katƒ±lƒ±rken hata: ' + error.message);
    }
});

// Join Session - Step 2: Participant Selection
document.getElementById('cancelSelectParticipant').addEventListener('click', () => {
    selectParticipantModal.classList.add('hidden');
    currentSession = null;
});

document.getElementById('confirmSelectParticipant').addEventListener('click', async () => {
    const participantId = document.getElementById('participantSelect').value;

    if (!participantId) {
        alert('L√ºtfen bir katƒ±lƒ±mcƒ± se√ßin');
        return;
    }

    try {
        // Update participant with userId
        await update(ref(database, `sessions/${currentSession}/participants/${participantId}`), {
            userId: userId
        });

        currentParticipantId = participantId;
        isAdmin = false;
        localStorage.setItem('currentSession', currentSession);
        localStorage.setItem('currentParticipantId', participantId);
        localStorage.setItem('isAdmin', 'false');
        localStorage.removeItem('adminCode');

        selectParticipantModal.classList.add('hidden');
        loadSession(currentSession);

        showToast(`Oturuma katƒ±ldƒ±nƒ±z!`, 'success');
    } catch (error) {
        alert('Katƒ±lƒ±m sƒ±rasƒ±nda hata: ' + error.message);
    }
});

// Load Session
function loadSession(sessionCode) {
    const sessionRef = ref(database, `sessions/${sessionCode}`);

    onValue(sessionRef, (snapshot) => {
        if (!snapshot.exists()) {
            alert('Oturum sonlandƒ±rƒ±ldƒ±.');
            leaveSession();
            return;
        }

        const data = snapshot.val();

        // Ensure all required fields exist with defaults
        sessionData = {
            participants: data.participants || {},
            drinks: data.drinks || {},
            drinkTypes: data.drinkTypes || [],
            drinkHistory: data.drinkHistory || {},
            undoStack: data.undoStack || [],
            notifications: data.notifications || [],
            pendingDeletions: data.pendingDeletions || {},
            adminCode: data.adminCode,
            adminUserId: data.adminUserId,
            createdAt: data.createdAt
        };

        showSessionInfo();
        renderMainContent();
        updateNotificationCount();
        if (isAdmin) {
            updateApprovalCount();
        }
    });
}

// Render Main Content
function renderMainContent() {
    let html = '';

    if (isAdmin) {
        html += `
            <div class="admin-controls">
                <button class="btn-primary" onclick="window.openAddParticipantModal()">+ Katƒ±lƒ±mcƒ± Ekle</button>
                <button class="undo-btn" onclick="window.undoLastAction()" ${!canUndo() ? 'disabled' : ''}>‚Ü∂ Geri Al</button>
            </div>
        `;
    }

    // Render participants
    const now = Date.now();
    const participants = sessionData.participants || {};

    if (Object.keys(participants).length === 0) {
        html += '<div class="empty-state">Hen√ºz katƒ±lƒ±mcƒ± yok. + Katƒ±lƒ±mcƒ± Ekle butonuna tƒ±klayƒ±n!</div>';
        mainContent.innerHTML = html;
        return;
    }

    Object.entries(participants).forEach(([pid, participant]) => {
        if (!participant.isActive) return;

        const isSelf = pid === currentParticipantId;
        const needsAttention = checkIfNeedsAttention(pid, now);
        const stats = getParticipantStats(pid, now);
        const drinks = (sessionData.drinks && sessionData.drinks[pid]) ? sessionData.drinks[pid] : {};
        const canEdit = isAdmin || isSelf;

        // Safely get drink entries
        const drinkEntries = drinks && typeof drinks === 'object' ? Object.entries(drinks) : [];

        html += `
            <div class="participant-card ${needsAttention ? 'needs-attention' : ''}">
                <div class="participant-header">
                    <div>
                        <div class="participant-name ${isSelf ? 'self' : ''}">${participant.name}${isSelf ? ' (Ben)' : ''}</div>
                        <div class="participant-info">
                            ${stats.lastDrinkTime}<br>
                            ${stats.avgTimeInfo}
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        ${needsAttention ? '<span class="attention-badge">‚ö†Ô∏è Kontrol Et</span>' : ''}
                        ${isAdmin ? `<button class="btn-icon btn-delete" onclick="window.removeParticipant('${pid}')" title="Katƒ±lƒ±mcƒ±yƒ± √áƒ±kar">‚úï</button>` : ''}
                    </div>
                </div>

                ${drinkEntries.length > 0 ? drinkEntries.map(([drinkType, quantity]) => `
                    <div class="drink-item">
                        <div class="drink-info">
                            <span class="drink-name">${drinkType}</span>
                            <span class="drink-quantity">${quantity}</span>
                        </div>
                        ${canEdit ? `
                            <div class="drink-actions">
                                <button class="btn-icon btn-decrease" onclick="window.adjustDrink('${pid}', '${drinkType}', -1)">‚àí</button>
                                <button class="btn-icon btn-increase" onclick="window.adjustDrink('${pid}', '${drinkType}', 1)">+</button>
                                <button class="btn-icon btn-delete" onclick="window.deleteDrink('${pid}', '${drinkType}')">üóëÔ∏è</button>
                            </div>
                        ` : ''}
                    </div>
                `).join('') : '<div class="empty-state" style="padding: 10px 0; font-size: 14px;">Hen√ºz i√ßki eklenmedi</div>'}

                ${canEdit ? `<button class="btn-primary add-drink-btn" onclick="window.openAddDrinkModal('${pid}')">+ ƒ∞√ßki Ekle</button>` : ''}
            </div>
        `;
    });

    // Admin controls at bottom
    if (isAdmin) {
        html += `
            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button class="btn-primary btn-danger" onclick="window.requestAdminAction('clearAll')" style="flex: 1;">T√ºm√ºn√º Sil</button>
                <button class="btn-primary btn-danger" onclick="window.requestAdminAction('endSession')" style="flex: 1;">Oturumu Sonlandƒ±r</button>
            </div>
        `;
    } else {
        html += `
            <div style="margin-top: 20px;">
                <button class="btn-primary btn-secondary" onclick="window.leaveSession()">Oturumdan Ayrƒ±l</button>
            </div>
        `;
    }

    mainContent.innerHTML = html;
}

// Check if participant needs attention
function checkIfNeedsAttention(participantId, now) {
    if (!sessionData.drinkHistory || !sessionData.drinkHistory[participantId]) {
        return false;
    }

    const history = sessionData.drinkHistory[participantId] || [];
    if (history.length < 2) return false;

    const sortedHistory = [...history].sort((a, b) => b.timestamp - a.timestamp);
    const lastDrink = sortedHistory[0];
    const timeSinceLast = (now - lastDrink.timestamp) / 1000 / 60;

    const intervals = [];
    for (let i = 0; i < sortedHistory.length - 1; i++) {
        intervals.push((sortedHistory[i].timestamp - sortedHistory[i + 1].timestamp) / 1000 / 60);
    }
    const avgInterval = intervals.reduce((a, b) => a + b, 0) / intervals.length;

    return timeSinceLast > (avgInterval * 1.5);
}

// Get participant stats
function getParticipantStats(participantId, now) {
    if (!sessionData.drinkHistory || !sessionData.drinkHistory[participantId]) {
        return {
            lastDrinkTime: 'Son i√ßki: -',
            avgTimeInfo: 'Ort. aralƒ±k: -'
        };
    }

    const history = sessionData.drinkHistory[participantId] || [];

    if (history.length === 0) {
        return {
            lastDrinkTime: 'Son i√ßki: -',
            avgTimeInfo: 'Ort. aralƒ±k: -'
        };
    }

    const sortedHistory = [...history].sort((a, b) => b.timestamp - a.timestamp);
    const lastDrink = sortedHistory[0];
    const timeSinceLast = Math.floor((now - lastDrink.timestamp) / 1000 / 60);

    let lastDrinkText = `Son i√ßki: ${timeSinceLast}d √∂nce`;

    if (history.length < 2) {
        return {
            lastDrinkTime: lastDrinkText,
            avgTimeInfo: 'Ort. aralƒ±k: -'
        };
    }

    const intervals = [];
    for (let i = 0; i < sortedHistory.length - 1; i++) {
        intervals.push((sortedHistory[i].timestamp - sortedHistory[i + 1].timestamp) / 1000 / 60);
    }
    const avgInterval = Math.floor(intervals.reduce((a, b) => a + b, 0) / intervals.length);

    return {
        lastDrinkTime: lastDrinkText,
        avgTimeInfo: `Ort. aralƒ±k: ${avgInterval}d`
    };
}

// Open Add Participant Modal (during session)
window.openAddParticipantModal = function() {
    if (!isAdmin) return;
    addParticipantSessionModal.classList.remove('hidden');
    document.getElementById('newParticipantNameInput').value = '';
    document.getElementById('newParticipantNameInput').focus();
};

document.getElementById('cancelAddParticipantSession').addEventListener('click', () => {
    addParticipantSessionModal.classList.add('hidden');
});

document.getElementById('newParticipantNameInput').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') document.getElementById('confirmAddParticipantSession').click();
});

document.getElementById('confirmAddParticipantSession').addEventListener('click', async () => {
    const name = document.getElementById('newParticipantNameInput').value.trim();

    if (!name) {
        alert('L√ºtfen bir isim girin');
        return;
    }

    const existingNames = Object.values(sessionData.participants)
        .filter(p => p.isActive)
        .map(p => p.name.toLowerCase());

    if (existingNames.includes(name.toLowerCase())) {
        alert('Bu isim zaten mevcut');
        return;
    }

    const newId = generateParticipantId();
    const newParticipant = {
        name: name,
        userId: null,
        addedAt: Date.now(),
        addedBy: 'admin',
        isActive: true
    };

    try {
        await update(ref(database, `sessions/${currentSession}/participants/${newId}`), newParticipant);
        addParticipantSessionModal.classList.add('hidden');
        showToast(`${name} eklendi`, 'success');
    } catch (error) {
        alert('Katƒ±lƒ±mcƒ± eklenirken hata: ' + error.message);
    }
});

// Open Add Drink Modal
window.openAddDrinkModal = function(participantId) {
    if (!isAdmin && participantId !== currentParticipantId) return;

    const participant = sessionData.participants[participantId];
    if (!participant) return;

    document.getElementById('addDrinkForName').textContent = `${participant.name} i√ßin:`;

    // Update drink type datalist
    const datalist = document.getElementById('drinkTypeList');
    const drinkTypes = sessionData.drinkTypes || [];
    datalist.innerHTML = drinkTypes.map(type => `<option value="${type}">`).join('');

    document.getElementById('drinkTypeInput').value = '';
    document.getElementById('drinkQuantityInput').value = '1';

    pendingAction = { type: 'addDrink', participantId: participantId };
    addDrinkModal.classList.remove('hidden');
    document.getElementById('drinkTypeInput').focus();
};

document.getElementById('cancelAddDrink').addEventListener('click', () => {
    addDrinkModal.classList.add('hidden');
    pendingAction = null;
});

document.getElementById('drinkTypeInput').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        e.preventDefault();
        document.getElementById('drinkQuantityInput').focus();
    }
});

document.getElementById('drinkQuantityInput').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') document.getElementById('confirmAddDrink').click();
});

document.getElementById('confirmAddDrink').addEventListener('click', async () => {
    if (!pendingAction || pendingAction.type !== 'addDrink') return;

    const drinkType = document.getElementById('drinkTypeInput').value.trim();
    const quantity = parseInt(document.getElementById('drinkQuantityInput').value);
    const participantId = pendingAction.participantId;

    if (!drinkType || quantity < 1) {
        alert('L√ºtfen ge√ßerli bir i√ßki t√ºr√º ve miktar girin');
        return;
    }

    const participant = sessionData.participants[participantId];
    const existingDrinkType = sessionData.drinkTypes.find(d => d.toLowerCase() === drinkType.toLowerCase()) || drinkType;

    const updatedDrinks = { ...sessionData.drinks };
    const updatedDrinkTypes = [...sessionData.drinkTypes];
    const updatedHistory = { ...sessionData.drinkHistory };
    const updatedUndo = [...(sessionData.undoStack || [])];

    if (!updatedDrinkTypes.some(d => d.toLowerCase() === existingDrinkType.toLowerCase())) {
        updatedDrinkTypes.push(existingDrinkType);
    }

    if (!updatedDrinks[participantId]) {
        updatedDrinks[participantId] = {};
    }

    const oldQuantity = updatedDrinks[participantId][existingDrinkType] || 0;
    updatedDrinks[participantId][existingDrinkType] = oldQuantity + quantity;

    if (!updatedHistory[participantId]) {
        updatedHistory[participantId] = [];
    }

    const timestamp = Date.now();
    updatedHistory[participantId].push({
        drink: existingDrinkType,
        quantity: quantity,
        timestamp: timestamp,
        addedBy: isAdmin ? 'admin' : participantId
    });

    // Add to undo stack
    updatedUndo.push({
        action: 'addDrink',
        participantId: participantId,
        drink: existingDrinkType,
        quantity: quantity,
        timestamp: timestamp,
        expiresAt: timestamp + 30000 // 30 seconds
    });

    try {
        await update(ref(database, `sessions/${currentSession}`), {
            drinks: updatedDrinks,
            drinkTypes: updatedDrinkTypes,
            drinkHistory: updatedHistory,
            undoStack: updatedUndo
        });

        // Add notification logic (FIXED: Ensure notification is added for participants too)
        const addedByName = isAdmin ? 'Y√∂netici' : participant.name;
        const notificationMessage = `${addedByName} ${participant.name === addedByName ? '' : `${participant.name} i√ßin `}${quantity} ${existingDrinkType} ekledi`;
        await addNotification(notificationMessage, 'info');

        addDrinkModal.classList.add('hidden');
        pendingAction = null;

        // Notify admin if participant added
        if (!isAdmin) {
            // Will be shown via Firebase listener
        }
    } catch (error) {
        alert('ƒ∞√ßki eklenirken hata: ' + error.message);
    }
});

// Adjust Drink
window.adjustDrink = function(participantId, drinkType, change) {
    if (!isAdmin && participantId !== currentParticipantId) return;

    const participant = sessionData.participants[participantId];
    const currentQty = sessionData.drinks[participantId]?.[drinkType] || 0;
    const newQty = currentQty + change;

    let message;
    if (newQty <= 0) {
        message = `${participant.name} i√ßin ${drinkType} silinecek. Devam edilsin mi?`;
    } else if (change > 0) {
        message = `${participant.name} i√ßin ${Math.abs(change)} adet daha ${drinkType} eklensin mi? (${currentQty} ‚Üí ${newQty})`;
    } else {
        message = `${participant.name} i√ßin ${drinkType} miktarƒ± ${currentQty}'den ${newQty}'e d√º≈ü√ºr√ºls√ºn m√º?`;
    }

    document.getElementById('adjustDrinkMessage').textContent = message;
    pendingAction = { type: 'adjustDrink', participantId, drinkType, change };
    adjustDrinkModal.classList.remove('hidden');
};

document.getElementById('cancelAdjustDrink').addEventListener('click', () => {
    adjustDrinkModal.classList.add('hidden');
    pendingAction = null;
});

document.getElementById('confirmAdjustDrink').addEventListener('click', async () => {
    if (!pendingAction || pendingAction.type !== 'adjustDrink') return;

    const { participantId, drinkType, change } = pendingAction;

    const updatedDrinks = { ...sessionData.drinks };
    const updatedHistory = { ...sessionData.drinkHistory };
    const updatedUndo = [...(sessionData.undoStack || [])];
    const timestamp = Date.now();

    const currentQty = updatedDrinks[participantId]?.[drinkType] || 0;
    const newQty = currentQty + change;

    if (change > 0) {
        updatedDrinks[participantId][drinkType] = newQty;

        if (!updatedHistory[participantId]) {
            updatedHistory[participantId] = [];
        }
        updatedHistory[participantId].push({
            drink: drinkType,
            quantity: change,
            timestamp: timestamp,
            addedBy: isAdmin ? 'admin' : participantId
        });

        updatedUndo.push({
            action: 'adjustDrink',
            participantId: participantId,
            drink: drinkType,
            oldValue: currentQty,
            newValue: newQty,
            timestamp: timestamp,
            expiresAt: timestamp + 30000
        });
    } else {
        // Decrease
        if (newQty <= 0) {
            delete updatedDrinks[participantId][drinkType];
            if (Object.keys(updatedDrinks[participantId]).length === 0) {
                delete updatedDrinks[participantId];
            }
        } else {
            updatedDrinks[participantId][drinkType] = newQty;
        }

        // Remove from history
        if (updatedHistory[participantId]) {
            for (let i = updatedHistory[participantId].length - 1; i >= 0; i--) {
                if (updatedHistory[participantId][i].drink === drinkType) {
                    updatedHistory[participantId].splice(i, 1);
                    break;
                }
            }
            if (updatedHistory[participantId].length === 0) {
                delete updatedHistory[participantId];
            }
        }

        updatedUndo.push({
            action: 'adjustDrink',
            participantId: participantId,
            drink: drinkType,
            oldValue: currentQty,
            newValue: newQty,
            timestamp: timestamp,
            expiresAt: timestamp + 30000
        });
    }

    try {
        await update(ref(database, `sessions/${currentSession}`), {
            drinks: updatedDrinks,
            drinkHistory: updatedHistory,
            undoStack: updatedUndo
        });

        adjustDrinkModal.classList.add('hidden');
        pendingAction = null;
    } catch (error) {
        alert('Miktar ayarlanƒ±rken hata: ' + error.message);
    }
});

// Delete Drink
window.deleteDrink = async function(participantId, drinkType) {
    if (!isAdmin && participantId !== currentParticipantId) return;

    const participant = sessionData.participants[participantId];

    // If participant is deleting their own drink, request admin approval
    if (!isAdmin && participantId === currentParticipantId) {
        const message = `${participant.name}, ${drinkType} silme isteƒüi g√∂nderdi`;

        try {
            await addNotification(message, 'warning');

            // Add to pending deletions
            const pendingDeletions = sessionData.pendingDeletions || {};
            const deleteId = `del_${Date.now()}`;
            pendingDeletions[deleteId] = {
                participantId: participantId,
                participantName: participant.name,
                drinkType: drinkType,
                requestedAt: Date.now(),
                requestedBy: participantId
            };

            await update(ref(database, `sessions/${currentSession}`), {
                pendingDeletions: pendingDeletions
            });

            showToast('Silme isteƒüi admin onayƒ±na g√∂nderildi', 'info');
        } catch (error) {
            alert('ƒ∞stek g√∂nderilirken hata: ' + error.message);
        }
        return;
    }

    // Admin can delete directly
    document.getElementById('deleteDrinkMessage').textContent =
        `${participant.name} i√ßin ${drinkType} silinsin mi?`;

    pendingAction = { type: 'deleteDrink', participantId, drinkType };
    deleteDrinkModal.classList.remove('hidden');
};

document.getElementById('cancelDeleteDrink').addEventListener('click', () => {
    deleteDrinkModal.classList.add('hidden');
    pendingAction = null;
});

document.getElementById('confirmDeleteDrink').addEventListener('click', async () => {
    if (!pendingAction || pendingAction.type !== 'deleteDrink') return;

    const { participantId, drinkType } = pendingAction;

    const updatedDrinks = { ...sessionData.drinks };
    const updatedHistory = { ...sessionData.drinkHistory };
    const updatedUndo = [...(sessionData.undoStack || [])];
    const timestamp = Date.now();

    const oldQuantity = updatedDrinks[participantId]?.[drinkType] || 0;

    delete updatedDrinks[participantId][drinkType];
    if (Object.keys(updatedDrinks[participantId]).length === 0) {
        delete updatedDrinks[participantId];
    }

    if (updatedHistory[participantId]) {
        updatedHistory[participantId] = updatedHistory[participantId].filter(entry => entry.drink !== drinkType);
        if (updatedHistory[participantId].length === 0) {
            delete updatedHistory[participantId];
        }
    }

    updatedUndo.push({
        action: 'deleteDrink',
        participantId: participantId,
        drink: drinkType,
        oldValue: oldQuantity,
        timestamp: timestamp,
        expiresAt: timestamp + 30000
    });

    try {
        await update(ref(database, `sessions/${currentSession}`), {
            drinks: updatedDrinks,
            drinkHistory: updatedHistory,
            undoStack: updatedUndo
        });

        // Add notification
        const participant = sessionData.participants[participantId];
        await addNotification(`${participant.name} i√ßin ${drinkType} silindi`, 'error');

        deleteDrinkModal.classList.add('hidden');
        pendingAction = null;
    } catch (error) {
        alert('ƒ∞√ßki silinirken hata: ' + error.message);
    }
});

// Undo functionality
function canUndo() {
    if (!sessionData.undoStack || sessionData.undoStack.length === 0) return false;
    const now = Date.now();
    return sessionData.undoStack.some(item => item.expiresAt > now);
}

window.undoLastAction = async function() {
    if (!isAdmin || !canUndo()) return;

    const now = Date.now();
    const validItems = sessionData.undoStack.filter(item => item.expiresAt > now);

    if (validItems.length === 0) {
        alert('Geri alƒ±nabilecek i≈ülem yok');
        return;
    }

    const lastAction = validItems[validItems.length - 1];
    const participant = sessionData.participants[lastAction.participantId];

    if (!confirm(`Son i≈ülem geri alƒ±nsƒ±n mƒ±?\n${participant.name} - ${lastAction.drink} (${lastAction.action})`)) {
        return;
    }

    const updatedDrinks = { ...sessionData.drinks };
    const updatedHistory = { ...sessionData.drinkHistory };
    const updatedUndo = sessionData.undoStack.filter(item => item !== lastAction);

    if (lastAction.action === 'addDrink' || lastAction.action === 'adjustDrink') {
        if (lastAction.oldValue !== undefined) {
            // Adjust drink
            if (lastAction.oldValue === 0) {
                delete updatedDrinks[lastAction.participantId][lastAction.drink];
                if (Object.keys(updatedDrinks[lastAction.participantId]).length === 0) {
                    delete updatedDrinks[lastAction.participantId];
                }
            } else {
                if (!updatedDrinks[lastAction.participantId]) {
                    updatedDrinks[lastAction.participantId] = {};
                }
                updatedDrinks[lastAction.participantId][lastAction.drink] = lastAction.oldValue;
            }
        } else {
            // Add drink - remove it
            const currentQty = updatedDrinks[lastAction.participantId]?.[lastAction.drink] || 0;
            const newQty = currentQty - lastAction.quantity;

            if (newQty <= 0) {
                delete updatedDrinks[lastAction.participantId][lastAction.drink];
                if (Object.keys(updatedDrinks[lastAction.participantId]).length === 0) {
                    delete updatedDrinks[lastAction.participantId];
                }
            } else {
                updatedDrinks[lastAction.participantId][lastAction.drink] = newQty;
            }
        }

        // Remove from history
        if (updatedHistory[lastAction.participantId]) {
            const historyIndex = updatedHistory[lastAction.participantId]
                .findIndex(h => h.timestamp === lastAction.timestamp && h.drink === lastAction.drink);
            if (historyIndex !== -1) {
                updatedHistory[lastAction.participantId].splice(historyIndex, 1);
                if (updatedHistory[lastAction.participantId].length === 0) {
                    delete updatedHistory[lastAction.participantId];
                }
            }
        }
    } else if (lastAction.action === 'deleteDrink') {
        // Restore deleted drink
        if (!updatedDrinks[lastAction.participantId]) {
            updatedDrinks[lastAction.participantId] = {};
        }
        updatedDrinks[lastAction.participantId][lastAction.drink] = lastAction.oldValue;
    }

    try {
        await update(ref(database, `sessions/${currentSession}`), {
            drinks: updatedDrinks,
            drinkHistory: updatedHistory,
            undoStack: updatedUndo
        });

        showToast('ƒ∞≈ülem geri alƒ±ndƒ±', 'success');
    } catch (error) {
        alert('Geri alma sƒ±rasƒ±nda hata: ' + error.message);
    }
};

// Admin actions
window.requestAdminAction = function(action) {
    if (!isAdmin) return;

    pendingAdminAction = action;

    // FIX 1: Bypass admin code for endSession if adminUserId matches current userId
    if (action === 'endSession' && sessionData.adminUserId === userId) {
        // Skip modal and proceed directly to confirmation/execution
        window.confirmAdminCode();
        return;
    }

    if (action === 'clearAll') {
        document.getElementById('adminCodeMessage').textContent = 'T√ºm i√ßkileri silmek i√ßin admin kodunu girin:';
    } else if (action === 'endSession') {
        document.getElementById('adminCodeMessage').textContent = 'Oturumu sonlandƒ±rmak i√ßin admin kodunu girin:';
    }

    document.getElementById('adminCodeInput').value = '';
    adminCodeModal.classList.remove('hidden');
    document.getElementById('adminCodeInput').focus();
};

document.getElementById('cancelAdminCode').addEventListener('click', () => {
    adminCodeModal.classList.add('hidden');
    pendingAdminAction = null;
});

document.getElementById('adminCodeInput').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') document.getElementById('confirmAdminCode').click();
});

document.getElementById('confirmAdminCode').addEventListener('click', async () => {
    const enteredCode = document.getElementById('adminCodeInput').value.trim();

    if (enteredCode !== adminCode) {
        alert('Yanlƒ±≈ü admin kodu');
        return;
    }

    adminCodeModal.classList.add('hidden');

    await executeAdminAction();
});

// Consolidated function to execute admin actions
window.confirmAdminCode = async function() {
    if (!isAdmin) return;

    if (pendingAdminAction === 'clearAll') {
        if (!confirm('T√ºm i√ßkiler silinecek. Emin misiniz?')) {
            pendingAdminAction = null;
            return;
        }

        try {
            await update(ref(database, `sessions/${currentSession}`), {
                drinks: {},
                drinkHistory: {},
                undoStack: []
            });
            showToast('T√ºm veriler silindi', 'warning');
        } catch (error) {
            alert('Veri silinirken hata: ' + error.message);
        }
    } else if (pendingAdminAction === 'endSession') {
        if (!confirm('Bu oturumu herkes i√ßin sonlandƒ±racak. Emin misiniz?')) {
            pendingAdminAction = null;
            return;
        }

        try {
            await remove(ref(database, `sessions/${currentSession}`));
            leaveSession();
        } catch (error) {
            alert('Oturum sonlandƒ±rƒ±lƒ±rken hata: ' + error.message);
        }
    }

    pendingAdminAction = null;
}

// Approve deletion request
window.approveDeletion = async function(deleteId) {
    if (!isAdmin) return;

    const pendingDeletions = { ...(sessionData.pendingDeletions || {}) };
    const deletion = pendingDeletions[deleteId];

    if (!deletion) return;

    const { participantId, drinkType, participantName } = deletion;

    const updatedDrinks = { ...sessionData.drinks };
    const updatedHistory = { ...sessionData.drinkHistory };

    // Delete the drink
    if (updatedDrinks[participantId] && updatedDrinks[participantId][drinkType]) {
        delete updatedDrinks[participantId][drinkType];
        if (Object.keys(updatedDrinks[participantId]).length === 0) {
            delete updatedDrinks[participantId];
        }
    }

    if (updatedHistory[participantId]) {
        updatedHistory[participantId] = updatedHistory[participantId].filter(entry => entry.drink !== drinkType);
        if (updatedHistory[participantId].length === 0) {
            delete updatedHistory[participantId];
        }
    }

    // Remove from pending
    delete pendingDeletions[deleteId];

    try {
        await update(ref(database, `sessions/${currentSession}`), {
            drinks: updatedDrinks,
            drinkHistory: updatedHistory,
            pendingDeletions: pendingDeletions
        });

        await addNotification(`${participantName} i√ßin ${drinkType} silme isteƒüi onaylandƒ±`, 'success');
        showToast('Silme isteƒüi onaylandƒ±', 'success');
        updateApprovalCount();
        renderApprovals();
    } catch (error) {
        alert('Onaylama sƒ±rasƒ±nda hata: ' + error.message);
    }
};

// Reject deletion request
window.rejectDeletion = async function(deleteId) {
    if (!isAdmin) return;

    const pendingDeletions = { ...(sessionData.pendingDeletions || {}) };
    const deletion = pendingDeletions[deleteId];

    if (!deletion) return;

    delete pendingDeletions[deleteId];

    try {
        await update(ref(database, `sessions/${currentSession}`), {
            pendingDeletions: pendingDeletions
        });

        await addNotification(`${deletion.participantName} i√ßin ${deletion.drinkType} silme isteƒüi reddedildi`, 'warning');
        showToast('Silme isteƒüi reddedildi', 'warning');
        updateApprovalCount();
        renderApprovals();
    } catch (error) {
        alert('Reddetme sƒ±rasƒ±nda hata: ' + error.message);
    }
};

// Remove participant (admin only)
window.removeParticipant = async function(participantId) {
    if (!isAdmin) {
        alert('Sadece y√∂netici katƒ±lƒ±mcƒ± √ßƒ±karabilir');
        return;
    }

    const participant = sessionData.participants[participantId];
    if (!participant) return;

    if (!confirm(`${participant.name} oturumdan √ßƒ±karƒ±lsƒ±n mƒ±?`)) {
        return;
    }

    try {
        // Set participant as inactive instead of deleting
        await update(ref(database, `sessions/${currentSession}/participants/${participantId}`), {
            isActive: false
        });

        showToast(`${participant.name} √ßƒ±karƒ±ldƒ±`, 'warning');
    } catch (error) {
        alert('Katƒ±lƒ±mcƒ± √ßƒ±karƒ±lƒ±rken hata: ' + error.message);
    }
};

// Leave session
window.leaveSession = function() {
    if (confirm('Bu oturumdan ayrƒ±lmak istediƒüinize emin misiniz?')) {
        _leaveSession();
    }
};

function _leaveSession() {
    currentSession = null;
    isAdmin = false;
    adminCode = null;
    currentParticipantId = null;
    sessionData = {
        participants: {},
        drinks: {},
        drinkTypes: [],
        drinkHistory: {},
        undoStack: [],
        notifications: []
    };

    localStorage.removeItem('currentSession');
    localStorage.removeItem('isAdmin');
    localStorage.removeItem('adminCode');
    localStorage.removeItem('currentParticipantId');

    showSessionManagement();
}

// Auto-refresh every 30 seconds
setInterval(() => {
    if (currentSession) {
        renderMainContent();
    }
}, 30000);

// Check for attention-needed participants every 5 minutes (admin only)
let lastAttentionCheck = Date.now();
setInterval(() => {
    if (!isAdmin || !currentSession) return;

    const now = Date.now();
    const participants = sessionData.participants || {};

    Object.entries(participants).forEach(([pid, participant]) => {
        if (!participant.isActive) return;

        const needsAttention = checkIfNeedsAttention(pid, now);
        if (needsAttention) {
            // Only notify once every 15 minutes per participant
            const lastNotified = localStorage.getItem(`attention_${pid}`) || 0;
            if (now - lastNotified > 15 * 60 * 1000) {
                const message = `${participant.name} kontrole ihtiya√ß duyuyor`;
                showToast(message, 'warning');
                showBrowserNotification('‚ö†Ô∏è Kontrol Gerekli', message);
                localStorage.setItem(`attention_${pid}`, now.toString());
            }
        }
    });
}, 5 * 60 * 1000); // Every 5 minutes